<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Professional Drone Control System">
    <meta name="theme-color" content="#6C63FF">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Drone Control">
    <link rel="manifest" href="manifest.json">
    <title>Drone Control Pro</title>

    <style>
        /* ===== GLOBAL STYLES ===== */
        :root {
            /* Color Palette - Dark Theme */
            --primary-color: #6C63FF;
            --primary-light: #8B83FF;
            --primary-dark: #4D46CC;
            --secondary-color: #00D4FF;
            --success-color: #00E676;
            --warning-color: #FFB800;
            --danger-color: #FF3D71;
            --background-dark: #0F0F1E;
            --background-card: #1A1A2E;
            --background-elevated: #252538;
            --text-primary: #FFFFFF;
            --text-secondary: #B8B8D1;
            --text-muted: #6E6E8F;
            --border-color: #2E2E48;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --glass-bg: rgba(26, 26, 46, 0.8);

            /* Spacing */
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;

            /* Border Radius */
            --radius-sm: 0.5rem;
            --radius-md: 1rem;
            --radius-lg: 1.5rem;
            --radius-full: 50%;

            /* Transitions */
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;

            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 20px rgba(108, 99, 255, 0.5);
        }

        /* Light Theme */
        body.light-theme {
            --background-dark: #F5F5F7;
            --background-card: #FFFFFF;
            --background-elevated: #FAFAFA;
            --text-primary: #1A1A1A;
            --text-secondary: #4A4A4A;
            --text-muted: #8A8A8A;
            --border-color: #E0E0E0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.9);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--background-dark) 0%, #16213E 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .hidden {
            display: none !important;
        }

        /* ===== LOADING SCREEN ===== */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0F0F1E 0%, #1A1A2E 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            gap: var(--spacing-md);
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #loading-screen p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* ===== HEADER ===== */
        .app-header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            padding: var(--spacing-sm) var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .header-left .material-icons {
            color: var(--primary-color);
            font-size: 2rem;
        }

        .header-left h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        /* ===== CONNECTION STATUS ===== */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            background: var(--background-elevated);
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition-normal);
        }

        .status-indicator.connected {
            background: rgba(0, 230, 118, 0.1);
            color: var(--success-color);
            animation: pulse 2s infinite;
        }

        .status-indicator.connected .material-icons {
            color: var(--success-color);
        }

        .status-indicator.disconnected {
            background: rgba(255, 61, 113, 0.1);
            color: var(--danger-color);
        }

        .status-indicator.disconnected .material-icons {
            color: var(--danger-color);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* ===== ICON BUTTONS ===== */
        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--background-elevated);
            color: var(--text-primary);
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        /* ===== NAVIGATION TABS ===== */
        .nav-tabs {
            display: flex;
            background: var(--background-card);
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            flex: 1;
            min-width: 100px;
            padding: var(--spacing-sm);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: var(--transition-fast);
            position: relative;
        }

        .tab-btn .material-icons {
            font-size: 1.5rem;
        }

        .tab-btn:hover {
            background: var(--background-elevated);
            color: var(--text-primary);
        }

        .tab-btn.active {
            color: var(--primary-color);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-color);
            box-shadow: var(--shadow-glow);
        }

        /* ===== TAB CONTENT ===== */
        .tab-content {
            padding: var(--spacing-md);
            max-width: 1400px;
            margin: 0 auto;
        }

        .tab-panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--background-card);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: var(--transition-normal);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        /* ===== BUTTONS ===== */
        button {
            font-family: inherit;
            cursor: pointer;
            user-select: none;
        }

        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition-normal);
            box-shadow: var(--shadow-md);
            min-height: 48px;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .action-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }

        .action-btn.primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
        }

        .action-btn.success {
            background: linear-gradient(135deg, var(--success-color), #00C853);
            color: white;
        }

        .action-btn.warning {
            background: linear-gradient(135deg, var(--warning-color), #FF9100);
            color: white;
        }

        .action-btn.danger {
            background: linear-gradient(135deg, var(--danger-color), #FF1744);
            color: white;
            animation: dangerPulse 2s infinite;
        }

        @keyframes dangerPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 61, 113, 0.7);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(255, 61, 113, 0);
            }
        }

        .secondary-btn {
            background: var(--background-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition-fast);
        }

        .secondary-btn:hover {
            background: var(--background-card);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .secondary-btn.danger-outline {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .secondary-btn.danger-outline:hover {
            background: var(--danger-color);
            color: white;
        }

        /* ===== INPUTS ===== */
        input[type="text"],
        input[type="number"],
        input[type="search"],
        select {
            width: 100%;
            padding: var(--spacing-sm);
            background: var(--background-elevated);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition-fast);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="search"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1);
        }

        /* Range Sliders */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: var(--radius-sm);
            background: var(--background-elevated);
            outline: none;
            transition: var(--transition-fast);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: var(--radius-full);
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: var(--transition-fast);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: var(--shadow-glow);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: var(--radius-full);
            background: var(--primary-color);
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-md);
            transition: var(--transition-fast);
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: var(--shadow-glow);
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--background-elevated);
            border: 1px solid var(--border-color);
            transition: var(--transition-normal);
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 3px;
            background-color: var(--text-secondary);
            transition: var(--transition-normal);
            border-radius: var(--radius-full);
        }

        input:checked+.slider {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
            background-color: white;
        }

        /* ===== MODALS ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: var(--spacing-md);
        }

        .modal-content {
            background: var(--background-card);
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: modalSlide 0.3s ease;
        }

        .modal-content.large {
            max-width: 800px;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-body {
            padding: var(--spacing-md);
            max-height: calc(80vh - 150px);
            overflow-y: auto;
        }

        .modal-footer {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 80px;
            right: var(--spacing-md);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .toast {
            background: var(--background-card);
            color: var(--text-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            min-width: 300px;
            animation: toastSlide 0.3s ease;
            border-left: 4px solid var(--primary-color);
        }

        @keyframes toastSlide {
            from {
                opacity: 0;
                transform: translateX(100px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.success {
            border-left-color: var(--success-color);
        }

        .toast.error {
            border-left-color: var(--danger-color);
        }

        .toast.warning {
            border-left-color: var(--warning-color);
        }

        /* ===== DEBUG CONSOLE ===== */
        .debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: var(--background-card);
            border-top: 2px solid var(--border-color);
            z-index: 999;
            display: flex;
            flex-direction: column;
        }

        .debug-header {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--background-elevated);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .debug-header h4 {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .debug-output {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-sm);
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* ===== SCROLLBAR STYLING ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-elevated);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ===== CONTROL TAB STYLES ===== */

        /* Quick Stats Bar */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .stat-item {
            background: var(--background-card);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .stat-item .material-icons {
            font-size: 2rem;
            color: var(--primary-color);
        }

        .stat-info {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Control Panel */
        .control-panel {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            align-items: center;
        }

        /* Joystick Container */
        .joystick-container {
            background: var(--background-card);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .joystick-container h3 {
            text-align: center;
            margin-bottom: var(--spacing-md);
            font-size: 1.125rem;
            color: var(--text-secondary);
        }

        .joystick {
            width: 250px;
            height: 250px;
            border-radius: var(--radius-full);
            background: radial-gradient(circle, var(--background-elevated) 0%, var(--background-dark) 100%);
            border: 3px solid var(--border-color);
            position: relative;
            margin: 0 auto var(--spacing-sm);
            box-shadow: inset var(--shadow-lg);
        }

        .joystick::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            background: var(--background-elevated);
            border: 2px dashed var(--border-color);
        }

        .joystick-handle {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: var(--shadow-glow), inset 0 -4px 8px rgba(0, 0, 0, 0.3);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            transition: var(--transition-fast);
            z-index: 10;
        }

        .joystick-handle:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(0.95);
        }

        .joystick-handle::after {
            content: '';
            position: absolute;
            top: 15%;
            left: 15%;
            width: 30%;
            height: 30%;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.3);
            filter: blur(4px);
        }

        .joystick-info {
            display: flex;
            justify-content: space-around;
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-family: 'Courier New', monospace;
        }

        .joystick-info span {
            background: var(--background-elevated);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
        }

        /* Altitude Control */
        .altitude-control {
            background: var(--background-card);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-md);
        }

        .altitude-control h3 {
            font-size: 1.125rem;
            color: var(--text-secondary);
        }

        .control-btn {
            width: 80px;
            height: 80px;
            border: none;
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            box-shadow: var(--shadow-md);
        }

        .control-btn.altitude-up {
            background: linear-gradient(135deg, var(--success-color), #00C853);
            color: white;
        }

        .control-btn.altitude-down {
            background: linear-gradient(135deg, var(--warning-color), #FF9100);
            color: white;
        }

        .control-btn:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .control-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-btn .material-icons {
            font-size: 2rem;
        }

        .altitude-slider-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        #altitude-slider {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            width: 8px;
            height: 150px;
            background: linear-gradient(to top, var(--danger-color), var(--warning-color), var(--success-color));
            border-radius: var(--radius-sm);
            outline: none;
        }

        #altitude-value {
            position: absolute;
            right: -60px;
            background: var(--background-elevated);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.125rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        /* Speed Control */
        .speed-control {
            background: var(--background-card);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .speed-control label {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
        }

        .speed-control .material-icons {
            color: var(--primary-color);
        }

        #speed-value {
            color: var(--primary-color);
            font-weight: 700;
        }

        /* ===== MONITOR TAB STYLES ===== */

        .monitor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-md);
        }

        .monitor-card {
            background: var(--background-card);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .monitor-card h3 {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
            font-size: 1.125rem;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--spacing-sm);
        }

        .monitor-card h3 .material-icons {
            color: var(--primary-color);
        }

        /* Battery Display */
        .battery-display {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .battery-icon {
            width: 80px;
            height: 150px;
            border: 3px solid var(--text-secondary);
            border-radius: var(--radius-sm);
            position: relative;
            overflow: hidden;
        }

        .battery-icon::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 0 0 4px 4px;
        }

        .battery-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0;
            background: linear-gradient(to top, var(--danger-color), var(--warning-color), var(--success-color));
            transition: height 0.5s ease, background 0.5s ease;
        }

        .battery-stats {
            flex: 1;
        }

        .large-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
            margin-bottom: var(--spacing-xs);
        }

        .small-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-sm);
        }

        /* GPS Display */
        .gps-display {
            margin-bottom: var(--spacing-md);
        }

        .coordinate {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-sm);
            background: var(--background-elevated);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-xs);
        }

        .coordinate label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .coordinate span {
            font-family: 'Courier New', monospace;
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Flight Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
        }

        .stat {
            background: var(--background-elevated);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .stat label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat span {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Signal Display */
        .signal-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-md);
        }

        .signal-bars {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
            height: 80px;
        }

        .signal-bars .bar {
            width: 20px;
            background: var(--background-elevated);
            border-radius: var(--radius-sm);
            transition: var(--transition-normal);
        }

        .signal-bars .bar:nth-child(1) {
            height: 20%;
        }

        .signal-bars .bar:nth-child(2) {
            height: 40%;
        }

        .signal-bars .bar:nth-child(3) {
            height: 60%;
        }

        .signal-bars .bar:nth-child(4) {
            height: 80%;
        }

        .signal-bars .bar:nth-child(5) {
            height: 100%;
        }

        .signal-bars .bar.active {
            background: linear-gradient(to top, var(--primary-color), var(--secondary-color));
        }

        .signal-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .signal-quality {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* ===== CAMERA TAB STYLES ===== */

        .camera-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .video-wrapper {
            position: relative;
            background: var(--background-dark);
            border-radius: var(--radius-lg);
            overflow: hidden;
            aspect-ratio: 16 / 9;
            margin-bottom: var(--spacing-md);
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--border-color);
        }

        #video-canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: var(--background-dark);
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .overlay-info {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            color: white;
            font-family: 'Courier New', monospace;
        }

        .camera-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .camera-btn {
            background: var(--background-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            font-weight: 500;
            transition: var(--transition-normal);
            cursor: pointer;
        }

        .camera-btn:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .camera-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ai-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--background-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            margin-bottom: var(--spacing-md);
        }

        .detection-results {
            background: var(--background-card);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .detection-results h4 {
            margin-bottom: var(--spacing-sm);
            color: var(--text-secondary);
        }

        #detected-objects {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        #detected-objects li {
            background: var(--background-elevated);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: space-between;
        }

        /* ===== HISTORY TAB STYLES ===== */

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .history-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .history-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .search-filter {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .flight-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .flight-item {
            background: var(--background-card);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition-normal);
        }

        .flight-item:hover {
            border-color: var(--primary-color);
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        /* ===== SETTINGS TAB STYLES ===== */

        .settings-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .settings-group {
            background: var(--background-card);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            margin-bottom: var(--spacing-md);
        }

        .settings-group h3 {
            font-size: 1.125rem;
            margin-bottom: var(--spacing-md);
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--spacing-sm);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item label {
            color: var(--text-primary);
            font-weight: 500;
        }

        .app-info {
            text-align: center;
            padding: var(--spacing-md);
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Device List */
        .device-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-height: 400px;
            overflow-y: auto;
        }

        .device-item {
            background: var(--background-elevated);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .device-item:hover {
            background: var(--background-card);
            border-color: var(--primary-color);
        }

        .device-item .material-icons {
            color: var(--primary-color);
            font-size: 2rem;
        }

        .device-info {
            flex: 1;
        }

        .device-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .device-id {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'Courier New', monospace;
        }

        .scanning-text {
            text-align: center;
            color: var(--text-secondary);
            padding: var(--spacing-lg);
        }

        /* ===== RESPONSIVE DESIGN ===== */

        /* Tablets and smaller devices */
        @media (max-width: 1024px) {
            .control-panel {
                grid-template-columns: 1fr;
            }

            .joystick {
                width: 220px;
                height: 220px;
            }

            .monitor-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        /* Mobile devices */
        @media (max-width: 768px) {
            :root {
                --spacing-sm: 0.75rem;
                --spacing-md: 1rem;
                --spacing-lg: 1.5rem;
            }

            .app-header {
                padding: var(--spacing-sm);
            }

            .header-left h1 {
                font-size: 1.25rem;
            }

            .status-text {
                display: none;
            }

            .nav-tabs {
                padding: 0;
            }

            .tab-btn {
                min-width: 80px;
                padding: var(--spacing-xs);
                font-size: 0.7rem;
            }

            .tab-btn .material-icons {
                font-size: 1.25rem;
            }

            .tab-content {
                padding: var(--spacing-sm);
            }

            .quick-stats {
                grid-template-columns: 1fr;
                gap: var(--spacing-xs);
            }

            .stat-item {
                padding: var(--spacing-xs);
            }

            .stat-item .material-icons {
                font-size: 1.5rem;
            }

            .joystick {
                width: 180px;
                height: 180px;
            }

            .joystick-handle {
                width: 60px;
                height: 60px;
            }

            .altitude-control {
                padding: var(--spacing-md);
            }

            .control-btn {
                width: 60px;
                height: 60px;
            }

            .control-btn .material-icons {
                font-size: 1.5rem;
            }

            #altitude-slider {
                height: 120px;
            }

            .action-buttons {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }

            .action-btn {
                min-height: 56px;
                font-size: 0.875rem;
            }

            .monitor-grid {
                grid-template-columns: 1fr;
            }

            .battery-icon {
                width: 60px;
                height: 120px;
            }

            .large-value {
                font-size: 2rem;
            }

            .camera-controls {
                grid-template-columns: repeat(2, 1fr);
            }

            .history-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-sm);
            }

            .search-filter {
                grid-template-columns: 1fr;
            }

            .toast-container {
                left: var(--spacing-sm);
                right: var(--spacing-sm);
            }

            .toast {
                min-width: auto;
            }

            .modal-content {
                margin: var(--spacing-sm);
                max-height: 90vh;
            }
        }

        /* Small mobile devices */
        @media (max-width: 480px) {
            .header-left .material-icons {
                font-size: 1.5rem;
            }

            .header-left h1 {
                font-size: 1.125rem;
            }

            .joystick {
                width: 150px;
                height: 150px;
            }

            .joystick-handle {
                width: 50px;
                height: 50px;
            }

            .control-panel {
                gap: var(--spacing-sm);
            }

            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 0.75rem;
            }

            .control-btn .material-icons {
                font-size: 1.25rem;
            }

            .camera-controls {
                grid-template-columns: 1fr;
            }
        }

        /* Landscape orientation on mobile */
        @media (max-width: 896px) and (orientation: landscape) {
            .control-panel {
                grid-template-columns: 1fr 1fr;
            }

            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .monitor-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Large screens */
        @media (min-width: 1440px) {
            .tab-content {
                max-width: 1600px;
            }

            .monitor-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {

            .action-btn,
            .control-btn,
            .secondary-btn,
            .camera-btn {
                min-height: 48px;
                min-width: 48px;
            }

            .icon-btn {
                padding: var(--spacing-sm);
            }

            .tab-btn {
                padding: var(--spacing-sm) var(--spacing-xs);
            }
        }

        /* Print styles */
        @media print {

            .app-header,
            .nav-tabs,
            .debug-console,
            .toast-container {
                display: none;
            }

            .tab-panel {
                display: block !important;
                page-break-after: always;
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #FFFFFF;
                --shadow-sm: none;
                --shadow-md: 0 0 0 2px var(--primary-color);
                --shadow-lg: 0 0 0 3px var(--primary-color);
            }

            .card,
            .monitor-card,
            .settings-group {
                border-width: 2px;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loader"></div>
        <p>Initializing Drone Control System...</p>
    </div>

    <!-- Main App Container -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <span class="material-icons">flight</span>
                <h1>Drone Control</h1>
            </div>
            <div class="header-right">
                <div id="connection-status" class="status-indicator disconnected">
                    <span class="material-icons">bluetooth_disabled</span>
                    <span class="status-text">Disconnected</span>
                </div>
                <button id="menu-btn" class="icon-btn">
                    <span class="material-icons">menu</span>
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="control">
                <span class="material-icons">gamepad</span>
                <span>Control</span>
            </button>
            <button class="tab-btn" data-tab="monitor">
                <span class="material-icons">monitor</span>
                <span>Monitor</span>
            </button>
            <button class="tab-btn" data-tab="camera">
                <span class="material-icons">videocam</span>
                <span>Camera</span>
            </button>
            <button class="tab-btn" data-tab="history">
                <span class="material-icons">history</span>
                <span>History</span>
            </button>
            <button class="tab-btn" data-tab="settings">
                <span class="material-icons">settings</span>
                <span>Settings</span>
            </button>
        </nav>

        <!-- Tab Content Container -->
        <main class="tab-content">
            <!-- CONTROL TAB -->
            <section id="control-tab" class="tab-panel active">
                <!-- Quick Stats Bar -->
                <div class="quick-stats">
                    <div class="stat-item">
                        <span class="material-icons">battery_charging_full</span>
                        <div class="stat-info">
                            <span class="stat-label">Battery</span>
                            <span id="battery-quick" class="stat-value">--</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span class="material-icons">location_on</span>
                        <div class="stat-info">
                            <span class="stat-label">Altitude</span>
                            <span id="altitude-quick" class="stat-value">--</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span class="material-icons">signal_cellular_alt</span>
                        <div class="stat-info">
                            <span class="stat-label">Signal</span>
                            <span id="signal-quick" class="stat-value">--</span>
                        </div>
                    </div>
                </div>

                <!-- Main Control Panel -->
                <div class="control-panel">
                    <!-- Virtual Joystick -->
                    <div class="joystick-container">
                        <h3>Direction Control</h3>
                        <div id="joystick" class="joystick">
                            <div id="joystick-handle" class="joystick-handle"></div>
                        </div>
                        <div class="joystick-info">
                            <span>X: <span id="joystick-x">0</span></span>
                            <span>Y: <span id="joystick-y">0</span></span>
                        </div>
                    </div>

                    <!-- Altitude Control -->
                    <div class="altitude-control">
                        <h3>Altitude Control</h3>
                        <button class="control-btn altitude-up" data-command="up">
                            <span class="material-icons">expand_less</span>
                            <span>UP</span>
                        </button>
                        <div class="altitude-slider-container">
                            <input type="range" id="altitude-slider" min="0" max="100" value="0" orient="vertical"
                                disabled>
                            <span id="altitude-value">0m</span>
                        </div>
                        <button class="control-btn altitude-down" data-command="down">
                            <span class="material-icons">expand_more</span>
                            <span>DOWN</span>
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button id="connect-btn" class="action-btn primary">
                        <span class="material-icons">bluetooth</span>
                        <span>Connect Drone</span>
                    </button>
                    <button id="takeoff-btn" class="action-btn success" disabled>
                        <span class="material-icons">flight_takeoff</span>
                        <span>Takeoff</span>
                    </button>
                    <button id="land-btn" class="action-btn warning" disabled>
                        <span class="material-icons">flight_land</span>
                        <span>Land</span>
                    </button>
                    <button id="emergency-btn" class="action-btn danger" disabled>
                        <span class="material-icons">warning</span>
                        <span>EMERGENCY STOP</span>
                    </button>
                </div>

                <!-- Speed Control -->
                <div class="speed-control">
                    <label for="speed-slider">
                        <span class="material-icons">speed</span>
                        Speed: <span id="speed-value">50</span>%
                    </label>
                    <input type="range" id="speed-slider" min="0" max="100" value="50">
                </div>
            </section>

            <!-- MONITOR TAB -->
            <section id="monitor-tab" class="tab-panel">
                <div class="monitor-grid">
                    <!-- Battery Status -->
                    <div class="monitor-card">
                        <h3><span class="material-icons">battery_charging_full</span> Battery Status</h3>
                        <div class="battery-display">
                            <div class="battery-icon">
                                <div id="battery-level" class="battery-fill" style="width: 0%"></div>
                            </div>
                            <div class="battery-stats">
                                <p class="large-value" id="battery-percentage">--</p>
                                <p class="small-label">Remaining</p>
                                <p id="battery-time">Est. flight time: --</p>
                            </div>
                        </div>
                    </div>

                    <!-- GPS Position -->
                    <div class="monitor-card">
                        <h3><span class="material-icons">gps_fixed</span> GPS Position</h3>
                        <div class="gps-display">
                            <div class="coordinate">
                                <label>Latitude:</label>
                                <span id="gps-lat">--</span>
                            </div>
                            <div class="coordinate">
                                <label>Longitude:</label>
                                <span id="gps-lng">--</span>
                            </div>
                            <div class="coordinate">
                                <label>Altitude:</label>
                                <span id="gps-alt">--</span>
                            </div>
                            <div class="coordinate">
                                <label>Satellites:</label>
                                <span id="gps-sats">--</span>
                            </div>
                        </div>
                        <button id="show-map-btn" class="secondary-btn">
                            <span class="material-icons">map</span>
                            Show on Map
                        </button>
                    </div>

                    <!-- Flight Stats -->
                    <div class="monitor-card">
                        <h3><span class="material-icons">speed</span> Flight Statistics</h3>
                        <div class="stats-grid">
                            <div class="stat">
                                <label>Speed:</label>
                                <span id="flight-speed">0 m/s</span>
                            </div>
                            <div class="stat">
                                <label>Distance:</label>
                                <span id="flight-distance">0 m</span>
                            </div>
                            <div class="stat">
                                <label>Flight Time:</label>
                                <span id="flight-time">00:00:00</span>
                            </div>
                            <div class="stat">
                                <label>Max Altitude:</label>
                                <span id="max-altitude">0 m</span>
                            </div>
                        </div>
                    </div>

                    <!-- Signal Strength -->
                    <div class="monitor-card">
                        <h3><span class="material-icons">signal_cellular_alt</span> Signal Strength</h3>
                        <div class="signal-display">
                            <div class="signal-bars">
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                            </div>
                            <p class="signal-value" id="signal-strength">--</p>
                            <p class="signal-quality" id="signal-quality">--</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CAMERA TAB -->
            <section id="camera-tab" class="tab-panel">
                <div class="camera-container">
                    <div class="video-wrapper">
                        <canvas id="video-canvas"></canvas>
                        <div id="video-overlay" class="video-overlay hidden">
                            <div class="overlay-info">
                                <span id="video-resolution">1920x1080</span>
                                <span id="video-fps">30 FPS</span>
                            </div>
                        </div>
                    </div>

                    <div class="camera-controls">
                        <button id="start-stream-btn" class="camera-btn">
                            <span class="material-icons">videocam</span>
                            <span>Start Stream</span>
                        </button>
                        <button id="stop-stream-btn" class="camera-btn" disabled>
                            <span class="material-icons">videocam_off</span>
                            <span>Stop Stream</span>
                        </button>
                        <button id="capture-btn" class="camera-btn" disabled>
                            <span class="material-icons">camera_alt</span>
                            <span>Capture</span>
                        </button>
                        <button id="record-btn" class="camera-btn" disabled>
                            <span class="material-icons">fiber_manual_record</span>
                            <span>Record</span>
                        </button>
                    </div>

                    <!-- AI Detection Toggle -->
                    <div class="ai-toggle">
                        <label class="switch">
                            <input type="checkbox" id="ai-detection-toggle">
                            <span class="slider"></span>
                        </label>
                        <span>AI Object Detection</span>
                    </div>

                    <!-- Detection Results -->
                    <div id="detection-results" class="detection-results hidden">
                        <h4>Detected Objects:</h4>
                        <ul id="detected-objects"></ul>
                    </div>
                </div>
            </section>

            <!-- HISTORY TAB -->
            <section id="history-tab" class="tab-panel">
                <div class="history-header">
                    <h2>Flight History</h2>
                    <div class="history-actions">
                        <button id="export-btn" class="secondary-btn">
                            <span class="material-icons">download</span>
                            Export
                        </button>
                        <button id="clear-history-btn" class="secondary-btn danger-outline">
                            <span class="material-icons">delete</span>
                            Clear All
                        </button>
                    </div>
                </div>

                <div class="search-filter">
                    <input type="text" id="search-flights" placeholder="Search flights...">
                    <select id="filter-flights">
                        <option value="all">All Flights</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>

                <div id="flight-list" class="flight-list">
                    <!-- Flight items will be populated by JavaScript -->
                </div>
            </section>

            <!-- SETTINGS TAB -->
            <section id="settings-tab" class="tab-panel">
                <div class="settings-container">
                    <div class="settings-group">
                        <h3>Connection Settings</h3>
                        <div class="setting-item">
                            <label for="auto-reconnect">Auto-reconnect</label>
                            <label class="switch">
                                <input type="checkbox" id="auto-reconnect" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <label for="connection-timeout">Connection Timeout (seconds)</label>
                            <input type="number" id="connection-timeout" value="10" min="5" max="60">
                        </div>
                    </div>

                    <div class="settings-group">
                        <h3>Control Settings</h3>
                        <div class="setting-item">
                            <label for="control-sensitivity">Control Sensitivity</label>
                            <input type="range" id="control-sensitivity" min="1" max="10" value="5">
                            <span id="sensitivity-value">5</span>
                        </div>
                        <div class="setting-item">
                            <label for="invert-controls">Invert Controls</label>
                            <label class="switch">
                                <input type="checkbox" id="invert-controls">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-group">
                        <h3>Display Settings</h3>
                        <div class="setting-item">
                            <label for="theme-select">Theme</label>
                            <select id="theme-select">
                                <option value="dark">Dark</option>
                                <option value="light">Light</option>
                                <option value="auto">Auto</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label for="units-select">Units</label>
                            <select id="units-select">
                                <option value="metric">Metric</option>
                                <option value="imperial">Imperial</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-group">
                        <h3>Advanced</h3>
                        <div class="setting-item">
                            <label for="enable-debug">Enable Debug Mode</label>
                            <label class="switch">
                                <input type="checkbox" id="enable-debug">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <button id="calibrate-btn" class="secondary-btn">
                            <span class="material-icons">tune</span>
                            Calibrate Drone
                        </button>
                    </div>

                    <div class="app-info">
                        <p>Drone Control Pro v1.0.0</p>
                        <p> 2026 Drone Control Systems</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Debug Console (hidden by default) -->
        <div id="debug-console" class="debug-console hidden">
            <div class="debug-header">
                <h4>Debug Console</h4>
                <button id="close-debug" class="icon-btn">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div id="debug-output" class="debug-output"></div>
        </div>

        <!-- Toasts/Notifications -->
        <div id="toast-container" class="toast-container"></div>
    </div>

    <!-- Modals -->
    <!-- Bluetooth Device Selection Modal -->
    <div id="device-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Drone</h3>
                <button class="close-modal">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="device-list" class="device-list">
                    <p class="scanning-text">Scanning for devices...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-connect" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Flight Details Modal -->
    <div id="flight-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>Flight Details</h3>
                <button class="close-modal">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body" id="flight-details">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="js/config.js"></script>
    <script src="js/bluetooth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/joystick.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/ai-detection.js"></script>
    <script src="js/app.js"></script>

    <script>
        // Configuration and Constants
        const CONFIG = {
            // Bluetooth
            BLUETOOTH: {
                SERVICE_UUID: '0000ffe0-0000-1000-8000-00805f9b34fb', // Generic drone service UUID
                CHARACTERISTIC_UUID: '0000ffe1-0000-1000-8000-00805f9b34fb',
                DEVICE_NAME_PREFIX: 'DRONE', // Filter devices by name
                RECONNECT_ATTEMPTS: 3,
                RECONNECT_DELAY: 2000, // ms
                CONNECTION_TIMEOUT: 10000, // ms
            },

            // Command Protocol
            COMMANDS: {
                // Movement commands
                FORWARD: 0x01,
                BACKWARD: 0x02,
                LEFT: 0x03,
                RIGHT: 0x04,
                UP: 0x05,
                DOWN: 0x06,
                STOP: 0x07,

                // Action commands
                TAKEOFF: 0x10,
                LAND: 0x11,
                EMERGENCY_STOP: 0x12,
                CALIBRATE: 0x13,

                // Query commands
                GET_BATTERY: 0x20,
                GET_POSITION: 0x21,
                GET_ALTITUDE: 0x22,
                GET_SPEED: 0x23,
                GET_SIGNAL: 0x24,

                // Camera commands
                START_STREAM: 0x30,
                STOP_STREAM: 0x31,
                CAPTURE_PHOTO: 0x32,
                START_RECORDING: 0x33,
                STOP_RECORDING: 0x34,
            },

            // Control Settings
            CONTROL: {
                JOYSTICK_DEADZONE: 10, // pixels
                MAX_SPEED: 100,
                DEFAULT_SPEED: 50,
                UPDATE_INTERVAL: 100, // ms - how often to send commands
                SENSITIVITY: 5,
            },

            // UI Settings
            UI: {
                TOAST_DURATION: 3000, // ms
                DEBUG_MAX_LINES: 100,
                ANIMATION_DURATION: 300, // ms
            },

            // Storage Keys
            STORAGE_KEYS: {
                FLIGHTS: 'drone_flights',
                SETTINGS: 'drone_settings',
                LAST_DEVICE: 'drone_last_device',
            },

            // Default Settings
            DEFAULT_SETTINGS: {
                autoReconnect: true,
                connectionTimeout: 10,
                controlSensitivity: 5,
                invertControls: false,
                theme: 'dark',
                units: 'metric',
                enableDebug: false,
            },

            // Video Settings
            VIDEO: {
                FPS: 30,
                WIDTH: 1280,
                HEIGHT: 720,
                CODEC: 'video/webm',
            },

            // AI Detection
            AI: {
                CONFIDENCE_THRESHOLD: 0.5,
                MODEL_URL: 'models/mobilenet_v2.tflite',
                LABELS_URL: 'models/labels.txt',
            },
        };

        // State Management
        class AppState {
            constructor() {
                this.connected = false;
                this.device = null;
                this.characteristic = null;
                this.isFlying = false;
                this.currentSpeed = CONFIG.CONTROL.DEFAULT_SPEED;
                this.battery = 0;
                this.position = { lat: 0, lng: 0, alt: 0 };
                this.altitude = 0;
                this.signal = 0;
                this.flightTime = 0;
                this.flightTimer = null;
                this.streamActive = false;
                this.recordingActive = false;
                this.aiDetectionEnabled = false;
                this.settings = { ...CONFIG.DEFAULT_SETTINGS };
                this.flightStartTime = null;
                this.telemetryInterval = null;
                this.commandQueue = [];
                this.isProcessingCommand = false;
            }

            reset() {
                this.connected = false;
                this.device = null;
                this.characteristic = null;
                this.isFlying = false;
                this.stopFlightTimer();
                this.stopTelemetry();
            }

            startFlightTimer() {
                this.flightStartTime = Date.now();
                this.flightTimer = setInterval(() => {
                    this.flightTime = Math.floor((Date.now() - this.flightStartTime) / 1000);
                    updateFlightTime(this.flightTime);
                }, 1000);
            }

            stopFlightTimer() {
                if (this.flightTimer) {
                    clearInterval(this.flightTimer);
                    this.flightTimer = null;
                }
            }

            startTelemetry() {
                // Poll drone for telemetry data every 500ms
                this.telemetryInterval = setInterval(() => {
                    if (this.connected) {
                        queueCommand(CONFIG.COMMANDS.GET_BATTERY);
                        queueCommand(CONFIG.COMMANDS.GET_POSITION);
                        queueCommand(CONFIG.COMMANDS.GET_SIGNAL);
                    }
                }, 500);
            }

            stopTelemetry() {
                if (this.telemetryInterval) {
                    clearInterval(this.telemetryInterval);
                    this.telemetryInterval = null;
                }
            }
        }

        // Global state instance
        const appState = new AppState();

        // Helper Functions
        const log = {
            info: (message) => {
                console.log(`[INFO] ${message}`);
                addDebugLog('info', message);
            },
            error: (message) => {
                console.error(`[ERROR] ${message}`);
                addDebugLog('error', message);
            },
            warn: (message) => {
                console.warn(`[WARN] ${message}`);
                addDebugLog('warn', message);
            },
            debug: (message) => {
                if (appState.settings.enableDebug) {
                    console.log(`[DEBUG] ${message}`);
                    addDebugLog('debug', message);
                }
            }
        };

        function addDebugLog(type, message) {
            const debugOutput = document.getElementById('debug-output');
            if (debugOutput && appState.settings.enableDebug) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `debug-log ${type}`;
                logEntry.textContent = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
                debugOutput.appendChild(logEntry);
                debugOutput.scrollTop = debugOutput.scrollHeight;

                // Limit log entries
                while (debugOutput.children.length > CONFIG.UI.DEBUG_MAX_LINES) {
                    debugOutput.removeChild(debugOutput.firstChild);
                }
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = document.createElement('span');
            icon.className = 'material-icons';
            icon.textContent = type === 'success' ? 'check_circle' :
                type === 'error' ? 'error' :
                    type === 'warning' ? 'warning' : 'info';

            const text = document.createElement('span');
            text.textContent = message;

            toast.appendChild(icon);
            toast.appendChild(text);
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'toastSlide 0.3s ease reverse';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, CONFIG.UI.TOAST_DURATION);
        }

        function updateFlightTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            const element = document.getElementById('flight-time');
            if (element) element.textContent = timeString;
        }

        function formatDistance(meters) {
            if (appState.settings.units === 'imperial') {
                const feet = meters * 3.28084;
                return feet > 5280 ? `${(feet / 5280).toFixed(2)} mi` : `${feet.toFixed(0)} ft`;
            }
            return meters > 1000 ? `${(meters / 1000).toFixed(2)} km` : `${meters.toFixed(0)} m`;
        }

        function formatSpeed(metersPerSecond) {
            if (appState.settings.units === 'imperial') {
                const mph = metersPerSecond * 2.23694;
                return `${mph.toFixed(1)} mph`;
            }
            return `${metersPerSecond.toFixed(1)} m/s`;
        }

        // Command Queue Management
        function queueCommand(command, params = []) {
            appState.commandQueue.push({ command, params });
            processCommandQueue();
        }

        async function processCommandQueue() {
            if (appState.isProcessingCommand || appState.commandQueue.length === 0) {
                return;
            }

            appState.isProcessingCommand = true;
            const { command, params } = appState.commandQueue.shift();

            try {
                await sendCommand(command, params);
            } catch (error) {
                log.error(`Failed to process command ${command}: ${error.message}`);
            }

            appState.isProcessingCommand = false;

            // Process next command if available
            if (appState.commandQueue.length > 0) {
                setTimeout(processCommandQueue, 50); // Small delay between commands
            }
        }
        // Bluetooth Communication Module

        // Check if Web Bluetooth API is supported
        function isBluetoothSupported() {
            return navigator.bluetooth !== undefined;
        }

        // Request Bluetooth device
        async function requestDevice() {
            try {
                log.info('Requesting Bluetooth device...');

                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: CONFIG.BLUETOOTH.DEVICE_NAME_PREFIX },
                        { services: [CONFIG.BLUETOOTH.SERVICE_UUID] }
                    ],
                    optionalServices: [CONFIG.BLUETOOTH.SERVICE_UUID]
                });

                log.info(`Device selected: ${device.name}`);
                return device;
            } catch (error) {
                if (error.name === 'NotFoundError') {
                    throw new Error('No device selected');
                }
                throw new Error(`Device request failed: ${error.message}`);
            }
        }

        // Connect to Bluetooth device
        async function connectToDevice(device) {
            try {
                log.info(`Connecting to ${device.name}...`);

                const server = await device.gatt.connect();
                log.info('GATT server connected');

                const service = await server.getPrimaryService(CONFIG.BLUETOOTH.SERVICE_UUID);
                log.info('Service discovered');

                const characteristic = await service.getCharacteristic(CONFIG.BLUETOOTH.CHARACTERISTIC_UUID);
                log.info('Characteristic discovered');

                // Subscribe to notifications
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);
                log.info('Notifications enabled');

                return { device, server, characteristic };
            } catch (error) {
                throw new Error(`Connection failed: ${error.message}`);
            }
        }

        // Handle incoming data from drone
        function handleCharacteristicValueChanged(event) {
            const value = event.target.value;
            const data = new Uint8Array(value.buffer);

            log.debug(`Received data: ${Array.from(data).map(b => b.toString(16).padStart(2, '0')).join(' ')}`);

            // Parse response based on command type
            if (data.length < 2) return;

            const commandType = data[0];

            switch (commandType) {
                case CONFIG.COMMANDS.GET_BATTERY:
                    if (data.length >= 2) {
                        appState.battery = data[1];
                        updateBatteryDisplay(appState.battery);
                    }
                    break;

                case CONFIG.COMMANDS.GET_POSITION:
                    if (data.length >= 13) {
                        // Parse GPS data: lat (4 bytes), lng (4 bytes), alt (4 bytes), sats (1 byte)
                        const lat = new DataView(value.buffer).getFloat32(1, true);
                        const lng = new DataView(value.buffer).getFloat32(5, true);
                        const alt = new DataView(value.buffer).getFloat32(9, true);
                        const sats = data[13];

                        appState.position = { lat, lng, alt };
                        appState.altitude = alt;
                        updatePositionDisplay(lat, lng, alt, sats);
                    }
                    break;

                case CONFIG.COMMANDS.GET_SIGNAL:
                    if (data.length >= 2) {
                        appState.signal = data[1];
                        updateSignalDisplay(appState.signal);
                    }
                    break;

                case CONFIG.COMMANDS.GET_SPEED:
                    if (data.length >= 5) {
                        const speed = new DataView(value.buffer).getFloat32(1, true);
                        updateSpeedDisplay(speed);
                    }
                    break;

                default:
                    log.debug(`Unknown command type: ${commandType}`);
            }
        }

        // Send command to drone
        async function sendCommand(command, params = []) {
            if (!appState.connected || !appState.characteristic) {
                throw new Error('Not connected to device');
            }

            // Build command packet: [CMD][PARAM1][PARAM2]...[CHECKSUM]
            const packet = [command, ...params];

            // Calculate simple checksum (XOR of all bytes)
            let checksum = 0;
            for (const byte of packet) {
                checksum ^= byte;
            }
            packet.push(checksum);

            const data = new Uint8Array(packet);
            log.debug(`Sending command: ${Array.from(data).map(b => b.toString(16).padStart(2, '0')).join(' ')}`);

            try {
                await appState.characteristic.writeValue(data);
            } catch (error) {
                throw new Error(`Failed to send command: ${error.message}`);
            }
        }

        // Connect button handler
        async function handleConnect() {
            try {
                if (!isBluetoothSupported()) {
                    showToast('Web Bluetooth is not supported in this browser', 'error');
                    log.error('Web Bluetooth not supported');
                    return;
                }

                // Show device selection modal
                showDeviceSelectionModal();

                const device = await requestDevice();
                const { characteristic } = await connectToDevice(device);

                appState.device = device;
                appState.characteristic = characteristic;
                appState.connected = true;

                // Set up disconnect handler
                device.addEventListener('gattserverdisconnected', handleDisconnect);

                // Update UI
                updateConnectionStatus(true);
                enableControls(true);

                // Save last device
                saveLastDevice(device.id);

                // Start telemetry
                appState.startTelemetry();

                showToast(`Connected to ${device.name}`, 'success');
                log.info(`Successfully connected to ${device.name}`);

                hideDeviceSelectionModal();
            } catch (error) {
                log.error(error.message);
                showToast(error.message, 'error');
                hideDeviceSelectionModal();
            }
        }

        // Disconnect handler
        function handleDisconnect() {
            log.warn('Device disconnected');
            appState.reset();
            updateConnectionStatus(false);
            enableControls(false);
            showToast('Drone disconnected', 'warning');

            // Auto-reconnect if enabled
            if (appState.settings.autoReconnect) {
                log.info('Attempting auto-reconnect...');
                setTimeout(attemptReconnect, CONFIG.BLUETOOTH.RECONNECT_DELAY);
            }
        }

        // Auto-reconnect function
        let reconnectAttempts = 0;
        async function attemptReconnect() {
            if (reconnectAttempts >= CONFIG.BLUETOOTH.RECONNECT_ATTEMPTS) {
                log.error('Max reconnect attempts reached');
                showToast('Failed to reconnect to drone', 'error');
                reconnectAttempts = 0;
                return;
            }

            reconnectAttempts++;
            log.info(`Reconnect attempt ${reconnectAttempts}/${CONFIG.BLUETOOTH.RECONNECT_ATTEMPTS}`);

            try {
                if (appState.device) {
                    const { characteristic } = await connectToDevice(appState.device);
                    appState.characteristic = characteristic;
                    appState.connected = true;
                    updateConnectionStatus(true);
                    enableControls(true);
                    appState.startTelemetry();
                    showToast('Reconnected to drone', 'success');
                    reconnectAttempts = 0;
                }
            } catch (error) {
                log.error(`Reconnect failed: ${error.message}`);
                setTimeout(attemptReconnect, CONFIG.BLUETOOTH.RECONNECT_DELAY);
            }
        }

        // Mock Bluetooth for testing without actual device
        class MockBluetoothDevice {
            constructor() {
                this.name = 'DRONE_SIMULATOR';
                this.id = 'mock-device-001';
                this.gatt = {
                    connect: async () => ({
                        getPrimaryService: async () => ({
                            getCharacteristic: async () => new MockCharacteristic()
                        })
                    })
                };
                this.addEventListener = () => { };
            }
        }

        class MockCharacteristic {
            constructor() {
                this.value = null;
                this.listeners = [];
                // Simulate telemetry
                this.startMockTelemetry();
            }

            async startNotifications() {
                log.info('[MOCK] Notifications started');
            }

            addEventListener(event, callback) {
                this.listeners.push(callback);
            }

            async writeValue(data) {
                log.debug(`[MOCK] Command sent: ${Array.from(data).map(b => b.toString(16)).join(' ')}`);

                // Simulate response after short delay
                setTimeout(() => {
                    this.simulateResponse(data[0]);
                }, 100);
            }

            simulateResponse(command) {
                let responseData;

                switch (command) {
                    case CONFIG.COMMANDS.GET_BATTERY:
                        responseData = new Uint8Array([command, Math.floor(Math.random() * 30 + 70)]);
                        break;
                    case CONFIG.COMMANDS.GET_POSITION:
                        const buffer = new ArrayBuffer(14);
                        const view = new DataView(buffer);
                        view.setUint8(0, command);
                        view.setFloat32(1, 34.0522 + (Math.random() - 0.5) * 0.01, true); // lat
                        view.setFloat32(5, -118.2437 + (Math.random() - 0.5) * 0.01, true); // lng
                        view.setFloat32(9, Math.random() * 50, true); // alt
                        view.setUint8(13, Math.floor(Math.random() * 3 + 8)); // sats
                        responseData = new Uint8Array(buffer);
                        break;
                    case CONFIG.COMMANDS.GET_SIGNAL:
                        responseData = new Uint8Array([command, Math.floor(Math.random() * 30 + 70)]);
                        break;
                    default:
                        return;
                }

                // Trigger notification
                this.listeners.forEach(listener => {
                    listener({
                        target: {
                            value: responseData
                        }
                    });
                });
            }

            startMockTelemetry() {
                // Periodically send telemetry updates
                setInterval(() => {
                    if (this.listeners.length > 0 && appState.connected) {
                        this.simulateResponse(CONFIG.COMMANDS.GET_BATTERY);
                        setTimeout(() => this.simulateResponse(CONFIG.COMMANDS.GET_POSITION), 50);
                        setTimeout(() => this.simulateResponse(CONFIG.COMMANDS.GET_SIGNAL), 100);
                    }
                }, 1000);
            }
        }

        // Enable mock mode for testing
        async function enableMockMode() {
            log.warn('Enabling mock mode for testing');
            showToast('Mock mode enabled - Using simulator', 'warning');

            const device = new MockBluetoothDevice();
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(CONFIG.BLUETOOTH.SERVICE_UUID);
            const characteristic = await service.getCharacteristic(CONFIG.BLUETOOTH.CHARACTERISTIC_UUID);

            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);

            appState.device = device;
            appState.characteristic = characteristic;
            appState.connected = true;

            updateConnectionStatus(true);
            enableControls(true);
            appState.startTelemetry();

            showToast('Connected to simulator', 'success');
        }

        // Device selection modal helpers
        function showDeviceSelectionModal() {
            document.getElementById('device-modal').classList.remove('hidden');
        }

        function hideDeviceSelectionModal() {
            document.getElementById('device-modal').classList.add('hidden');
        }

        // Storage helpers
        function saveLastDevice(deviceId) {
            localStorage.setItem(CONFIG.STORAGE_KEYS.LAST_DEVICE, deviceId);
        }

        function getLastDevice() {
            return localStorage.getItem(CONFIG.STORAGE_KEYS.LAST_DEVICE);
        }
        // UI Management and Event Handlers

        // Initialize UI
        function initializeUI() {
            // Tab switching
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.dataset.tab;

                    // Update active states
                    tabButtons.forEach(b => b.classList.remove('active'));
                    tabPanels.forEach(p => p.classList.remove('active'));

                    btn.classList.add('active');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });

            // Connect button
            document.getElementById('connect-btn').addEventListener('click', handleConnect);

            // Action buttons
            document.getElementById('takeoff-btn').addEventListener('click', handleTakeoff);
            document.getElementById('land-btn').addEventListener('click', handleLand);
            document.getElementById('emergency-btn').addEventListener('click', handleEmergency);

            // Speed slider
            document.getElementById('speed-slider').addEventListener('input', (e) => {
                appState.currentSpeed = parseInt(e.target.value);
                document.getElementById('speed-value').textContent = appState.currentSpeed;
            });

            // Camera controls
            document.getElementById('start-stream-btn').addEventListener('click', () => startVideoStream());
            document.getElementById('stop-stream-btn').addEventListener('click', () => stopVideoStream());
            document.getElementById('capture-btn').addEventListener('click', () => capturePhoto());
            document.getElementById('record-btn').addEventListener('click', () => toggleRecording());

            // Settings
            loadSettings();
            setupSettingsHandlers();

            // Modal close buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal').classList.add('hidden');
                });
            });

            document.getElementById('cancel-connect').addEventListener('click', hideDeviceSelectionModal);

            // Debug console
            document.getElementById('close-debug').addEventListener('click', () => {
                document.getElementById('debug-console').classList.add('hidden');
            });

            // Export/Clear history
            document.getElementById('export-btn').addEventListener('click', exportFlightHistory);
            document.getElementById('clear-history-btn').addEventListener('click', clearFlightHistory);

            // Show map
            document.getElementById('show-map-btn').addEventListener('click', showMapModal);

            // Calibrate
            document.getElementById('calibrate-btn').addEventListener('click', calibrateDrone);

            // AI Detection toggle
            document.getElementById('ai-detection-toggle').addEventListener('change', (e) => {
                appState.aiDetectionEnabled = e.target.checked;
                if (appState.aiDetectionEnabled) {
                    initAIDetection();
                }
            });

            // Initialize joystick and altitude controls
            initJoystick();
            setupAltitudeControls();

            // Load flight history
            loadFlightHistory();

            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            }, 1000);
        }

        // Update connection status UI
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            const icon = statusEl.querySelector('.material-icons');
            const text = statusEl.querySelector('.status-text');

            if (connected) {
                statusEl.classList.remove('disconnected');
                statusEl.classList.add('connected');
                icon.textContent = 'bluetooth_connected';
                text.textContent = 'Connected';
                document.getElementById('connect-btn').innerHTML = '<span class="material-icons">bluetooth_disabled</span><span>Disconnect</span>';
            } else {
                statusEl.classList.remove('connected');
                statusEl.classList.add('disconnected');
                icon.textContent = 'bluetooth_disabled';
                text.textContent = 'Disconnected';
                document.getElementById('connect-btn').innerHTML = '<span class="material-icons">bluetooth</span><span>Connect Drone</span>';
            }
        }

        // Enable/disable controls
        function enableControls(enabled) {
            document.getElementById('takeoff-btn').disabled = !enabled;
            document.getElementById('land-btn').disabled = !enabled;
            document.getElementById('emergency-btn').disabled = !enabled;
            document.getElementById('start-stream-btn').disabled = !enabled;
        }

        // Update battery display
        function updateBatteryDisplay(percentage) {
            document.getElementById('battery-quick').textContent = `${percentage}%`;
            document.getElementById('battery-percentage').textContent = `${percentage}%`;
            document.getElementById('battery-level').style.width = `${percentage}%`;

            // Update battery color based on level
            const batteryFill = document.getElementById('battery-level');
            if (percentage > 60) {
                batteryFill.style.background = 'var(--success-color)';
            } else if (percentage > 30) {
                batteryFill.style.background = 'var(--warning-color)';
            } else {
                batteryFill.style.background = 'var(--danger-color)';
            }

            // Estimate flight time (15 min at 100%)
            const minutes = Math.floor((percentage / 100) * 15);
            document.getElementById('battery-time').textContent = `Est. flight time: ${minutes} min`;
        }

        // Update position display
        function updatePositionDisplay(lat, lng, alt, sats) {
            document.getElementById('gps-lat').textContent = lat.toFixed(6);
            document.getElementById('gps-lng').textContent = lng.toFixed(6);
            document.getElementById('gps-alt').textContent = formatDistance(alt);
            document.getElementById('gps-sats').textContent = sats;
            document.getElementById('altitude-quick').textContent = formatDistance(alt);
            document.getElementById('altitude-value').textContent = formatDistance(alt);
        }

        // Update signal display
        function updateSignalDisplay(strength) {
            document.getElementById('signal-quick').textContent = `${strength}%`;
            document.getElementById('signal-strength').textContent = `${strength}%`;

            const quality = strength > 80 ? 'Excellent' : strength > 60 ? 'Good' : strength > 40 ? 'Fair' : 'Poor';
            document.getElementById('signal-quality').textContent = quality;

            // Update signal bars
            const bars = document.querySelectorAll('.signal-bars .bar');
            const activeBars = Math.ceil((strength / 100) * bars.length);
            bars.forEach((bar, index) => {
                if (index < activeBars) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            });
        }

        // Update speed display
        function updateSpeedDisplay(speed) {
            document.getElementById('flight-speed').textContent = formatSpeed(speed);
        }

        // Action Handlers
        async function handleTakeoff() {
            try {
                showToast('Initiating takeoff...', 'info');
                await queueCommand(CONFIG.COMMANDS.TAKEOFF);
                appState.isFlying = true;
                appState.startFlightTimer();
                showToast('Drone is airborne', 'success');
                log.info('Takeoff successful');
            } catch (error) {
                showToast(`Takeoff failed: ${error.message}`, 'error');
                log.error(`Takeoff error: ${error.message}`);
            }
        }

        async function handleLand() {
            try {
                showToast('Landing...', 'info');
                await queueCommand(CONFIG.COMMANDS.LAND);

                setTimeout(() => {
                    appState.isFlying = false;
                    appState.stopFlightTimer();
                    saveFlight();
                    showToast('Landing complete', 'success');
                    log.info('Landing successful');
                }, 3000); // Wait 3 seconds for landing
            } catch (error) {
                showToast(`Landing failed: ${error.message}`, 'error');
                log.error(`Landing error: ${error.message}`);
            }
        }

        async function handleEmergency() {
            const confirmed = confirm('Are you sure you want to execute EMERGENCY STOP? This will immediately cut power to motors.');
            if (!confirmed) return;

            try {
                await queueCommand(CONFIG.COMMANDS.EMERGENCY_STOP);
                appState.isFlying = false;
                appState.stopFlightTimer();
                showToast('EMERGENCY STOP activated', 'warning');
                log.warn('Emergency stop executed');
            } catch (error) {
                showToast(`Emergency stop failed: ${error.message}`, 'error');
                log.error(`Emergency stop error: ${error.message}`);
            }
        }

        async function calibrateDrone() {
            try {
                showToast('Calibrating drone...', 'info');
                await queueCommand(CONFIG.COMMANDS.CALIBRATE);
                showToast('Calibration complete', 'success');
            } catch (error) {
                showToast(`Calibration failed: ${error.message}`, 'error');
            }
        }

        // Settings handlers
        function setupSettingsHandlers() {
            document.getElementById('auto-reconnect').addEventListener('change', (e) => {
                appState.settings.autoReconnect = e.target.checked;
                saveSettings();
            });

            document.getElementById('connection-timeout').addEventListener('change', (e) => {
                appState.settings.connectionTimeout = parseInt(e.target.value);
                saveSettings();
            });

            document.getElementById('control-sensitivity').addEventListener('input', (e) => {
                appState.settings.controlSensitivity = parseInt(e.target.value);
                document.getElementById('sensitivity-value').textContent = e.target.value;
                saveSettings();
            });

            document.getElementById('invert-controls').addEventListener('change', (e) => {
                appState.settings.invertControls = e.target.checked;
                saveSettings();
            });

            document.getElementById('theme-select').addEventListener('change', (e) => {
                appState.settings.theme = e.target.value;
                applyTheme(e.target.value);
                saveSettings();
            });

            document.getElementById('units-select').addEventListener('change', (e) => {
                appState.settings.units = e.target.value;
                saveSettings();
            });

            document.getElementById('enable-debug').addEventListener('change', (e) => {
                appState.settings.enableDebug = e.target.checked;
                document.getElementById('debug-console').classList.toggle('hidden', !e.target.checked);
                saveSettings();
            });
        }

        function saveSettings() {
            localStorage.setItem(CONFIG.STORAGE_KEYS.SETTINGS, JSON.stringify(appState.settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem(CONFIG.STORAGE_KEYS.SETTINGS);
            if (saved) {
                appState.settings = { ...CONFIG.DEFAULT_SETTINGS, ...JSON.parse(saved) };
            }

            // Apply settings to UI
            document.getElementById('auto-reconnect').checked = appState.settings.autoReconnect;
            document.getElementById('connection-timeout').value = appState.settings.connectionTimeout;
            document.getElementById('control-sensitivity').value = appState.settings.controlSensitivity;
            document.getElementById('sensitivity-value').textContent = appState.settings.controlSensitivity;
            document.getElementById('invert-controls').checked = appState.settings.invertControls;
            document.getElementById('theme-select').value = appState.settings.theme;
            document.getElementById('units-select').value = appState.settings.units;
            document.getElementById('enable-debug').checked = appState.settings.enableDebug;

            applyTheme(appState.settings.theme);
            document.getElementById('debug-console').classList.toggle('hidden', !appState.settings.enableDebug);
        }

        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else if (theme === 'dark') {
                document.body.classList.remove('light-theme');
            } else if (theme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.body.classList.toggle('light-theme', !prefersDark);
            }
        }

        function showMapModal() {
            showToast('Map feature coming soon', 'info');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initializeUI);
        // Virtual Joystick Implementation

        class VirtualJoystick {
            constructor(container, handle) {
                this.container = container;
                this.handle = handle;
                this.active = false;
                this.centerX = 0;
                this.centerY = 0;
                this.currentX = 0;
                this.currentY = 0;
                this.maxDistance = 0;
                this.onMove = null;
                this.onRelease = null;

                this.init();
            }

            init() {
                const rect = this.container.getBoundingClientRect();
                this.centerX = rect.width / 2;
                this.centerY = rect.height / 2;
                this.maxDistance = (rect.width / 2) - 40; // Account for handle size

                // Touch events
                this.handle.addEventListener('touchstart', this.handleStart.bind(this));
                document.addEventListener('touchmove', this.handleMove.bind(this));
                document.addEventListener('touchend', this.handleEnd.bind(this));

                // Mouse events
                this.handle.addEventListener('mousedown', this.handleStart.bind(this));
                document.addEventListener('mousemove', this.handleMove.bind(this));
                document.addEventListener('mouseup', this.handleEnd.bind(this));

                // Reset position
                this.resetPosition();
            }

            handleStart(e) {
                e.preventDefault();
                this.active = true;
                this.handle.style.transition = 'none';
            }

            handleMove(e) {
                if (!this.active) return;
                e.preventDefault();

                const rect = this.container.getBoundingClientRect();
                let clientX, clientY;

                if (e.touches) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                // Calculate relative position
                let deltaX = clientX - rect.left - this.centerX;
                let deltaY = clientY - rect.top - this.centerY;

                // Apply deadzone
                if (Math.abs(deltaX) < CONFIG.CONTROL.JOYSTICK_DEADZONE) deltaX = 0;
                if (Math.abs(deltaY) < CONFIG.CONTROL.JOYSTICK_DEADZONE) deltaY = 0;

                // Limit to circle
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                if (distance > this.maxDistance) {
                    const angle = Math.atan2(deltaY, deltaX);
                    deltaX = Math.cos(angle) * this.maxDistance;
                    deltaY = Math.sin(angle) * this.maxDistance;
                }

                this.currentX = deltaX;
                this.currentY = deltaY;

                // Update handle position
                this.handle.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;

                // Normalize to -100 to 100
                const normalizedX = Math.round((deltaX / this.maxDistance) * 100);
                const normalizedY = Math.round((deltaY / this.maxDistance) * 100);

                // Update display
                document.getElementById('joystick-x').textContent = normalizedX;
                document.getElementById('joystick-y').textContent = -normalizedY; // Invert Y for intuitive control

                // Callback
                if (this.onMove) {
                    this.onMove(normalizedX, -normalizedY);
                }

                // Send movement commands
                this.sendMovementCommands(normalizedX, -normalizedY);
            }

            handleEnd(e) {
                if (!this.active) return;
                e.preventDefault();

                this.active = false;
                this.resetPosition();

                // Callback
                if (this.onRelease) {
                    this.onRelease();
                }

                // Send stop command
                queueCommand(CONFIG.COMMANDS.STOP);
            }

            resetPosition() {
                this.currentX = 0;
                this.currentY = 0;
                this.handle.style.transition = 'transform 0.2s ease';
                this.handle.style.transform = 'translate(-50%, -50%)';
                document.getElementById('joystick-x').textContent = '0';
                document.getElementById('joystick-y').textContent = '0';
            }

            sendMovementCommands(x, y) {
                if (!appState.connected || !appState.isFlying) return;

                // Determine primary direction based on joystick position
                const threshold = 20; // Minimum value to trigger movement

                if (Math.abs(x) < threshold && Math.abs(y) < threshold) {
                    return; // Within deadzone
                }

                // Calculate speed based on distance from center
                const speed = Math.min(100, Math.floor(Math.sqrt(x * x + y * y)));

                // Determine direction
                if (Math.abs(y) > Math.abs(x)) {
                    // Vertical movement dominant
                    if (y > threshold) {
                        queueCommand(CONFIG.COMMANDS.FORWARD, [speed]);
                    } else if (y < -threshold) {
                        queueCommand(CONFIG.COMMANDS.BACKWARD, [speed]);
                    }
                } else {
                    // Horizontal movement dominant
                    if (x > threshold) {
                        queueCommand(CONFIG.COMMANDS.RIGHT, [speed]);
                    } else if (x < -threshold) {
                        queueCommand(CONFIG.COMMANDS.LEFT, [speed]);
                    }
                }
            }
        }

        // Initialize joystick
        let joystick = null;

        function initJoystick() {
            const container = document.getElementById('joystick');
            const handle = document.getElementById('joystick-handle');

            joystick = new VirtualJoystick(container, handle);

            joystick.onMove = (x, y) => {
                log.debug(`Joystick: X=${x}, Y=${y}`);
            };

            joystick.onRelease = () => {
                log.debug('Joystick released');
            };
        }

        // Altitude control buttons
        function setupAltitudeControls() {
            const upBtn = document.querySelector('.altitude-up');
            const downBtn = document.querySelector('.altitude-down');

            let altitudeInterval = null;

            const startAltitudeCommand = (command) => {
                queueCommand(command, [appState.currentSpeed]);
                altitudeInterval = setInterval(() => {
                    queueCommand(command, [appState.currentSpeed]);
                }, CONFIG.CONTROL.UPDATE_INTERVAL);
            };

            const stopAltitudeCommand = () => {
                if (altitudeInterval) {
                    clearInterval(altitudeInterval);
                    altitudeInterval = null;
                }
                queueCommand(CONFIG.COMMANDS.STOP);
            };

            // Touch events
            upBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startAltitudeCommand(CONFIG.COMMANDS.UP);
            });
            upBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopAltitudeCommand();
            });

            downBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startAltitudeCommand(CONFIG.COMMANDS.DOWN);
            });
            downBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopAltitudeCommand();
            });

            // Mouse events
            upBtn.addEventListener('mousedown', () => startAltitudeCommand(CONFIG.COMMANDS.UP));
            upBtn.addEventListener('mouseup', stopAltitudeCommand);
            upBtn.addEventListener('mouseleave', stopAltitudeCommand);

            downBtn.addEventListener('mousedown', () => startAltitudeCommand(CONFIG.COMMANDS.DOWN));
            downBtn.addEventListener('mouseup', stopAltitudeCommand);
            downBtn.addEventListener('mouseleave', stopAltitudeCommand);
        }
        // Camera and Video Streaming Module

        let videoStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let animationFrame = null;

        const canvas = document.getElementById('video-canvas');
        const ctx = canvas ? canvas.getContext('2d') : null;

        // Initialize video stream
        async function startVideoStream() {
            try {
                if (!appState.connected) {
                    showToast('Connect to drone first', 'warning');
                    return;
                }

                showToast('Starting video stream...', 'info');

                // Send command to drone to start streaming
                await queueCommand(CONFIG.COMMANDS.START_STREAM);

                // For demo purposes, use device camera as placeholder
                // In  real implementation, this would receive video data via Bluetooth
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: CONFIG.VIDEO.WIDTH,
                        height: CONFIG.VIDEO.HEIGHT,
                        facingMode: 'environment' // Use back camera on mobile
                    }
                });

                appState.streamActive = true;

                // Create video element to capture frames
                const video = document.createElement('video');
                video.srcObject = videoStream;
                video.play();

                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    drawVideoFrame(video);
                });

                document.getElementById('video-overlay').classList.remove('hidden');
                document.getElementById('start-stream-btn').disabled = true;
                document.getElementById('stop-stream-btn').disabled = false;
                document.getElementById('capture-btn').disabled = false;
                document.getElementById('record-btn').disabled = false;

                showToast('Video stream started', 'success');
                log.info('Video stream active');

            } catch (error) {
                showToast(`Failed to start stream: ${error.message}`, 'error');
                log.error(`Stream error: ${error.message}`);
            }
        }

        // Draw video frames to canvas
        function drawVideoFrame(video) {
            if (!appState.streamActive) return;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // If AI detection is enabled, process frame
            if (appState.aiDetectionEnabled) {
                detectObjectsInFrame();
            }

            animationFrame = requestAnimationFrame(() => drawVideoFrame(video));
        }

        // Stop video stream
        async function stopVideoStream() {
            try {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                }

                if (animationFrame) {
                    cancelAnimationFrame(animationFrame);
                    animationFrame = null;
                }

                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }

                await queueCommand(CONFIG.COMMANDS.STOP_STREAM);

                appState.streamActive = false;

                document.getElementById('video-overlay').classList.add('hidden');
                document.getElementById('start-stream-btn').disabled = false;
                document.getElementById('stop-stream-btn').disabled = true;
                document.getElementById('capture-btn').disabled = true;
                document.getElementById('record-btn').disabled = true;

                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                showToast('Video stream stopped', 'info');
                log.info('Video stream stopped');

            } catch (error) {
                showToast(`Error stopping stream: ${error.message}`, 'error');
            }
        }

        // Capture photo
        async function capturePhoto() {
            try {
                await queueCommand(CONFIG.COMMANDS.CAPTURE_PHOTO);

                // Capture from canvas
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `drone_photo_${Date.now()}.png`;
                    a.click();
                    URL.revokeObjectURL(url);

                    showToast('Photo captured', 'success');
                    log.info('Photo captured');
                });

            } catch (error) {
                showToast(`Capture failed: ${error.message}`, 'error');
            }
        }

        // Toggle recording
        async function toggleRecording() {
            if (appState.recordingActive) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        // Start recording
        async function startRecording() {
            try {
                recordedChunks = [];

                const stream = canvas.captureStream(CONFIG.VIDEO.FPS);
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: CONFIG.VIDEO.CODEC
                });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: CONFIG.VIDEO.CODEC });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `drone_recording_${Date.now()}.webm`;
                    a.click();
                    URL.revokeObjectURL(url);

                    showToast('Recording saved', 'success');
                };

                mediaRecorder.start();
                appState.recordingActive = true;

                document.getElementById('record-btn').innerHTML = '<span class="material-icons">stop</span><span>Stop Record</span>';
                document.getElementById('record-btn').style.background = 'var(--danger-color)';

                await queueCommand(CONFIG.COMMANDS.START_RECORDING);

                showToast('Recording started', 'success');
                log.info('Recording started');

            } catch (error) {
                showToast(`Recording failed: ${error.message}`, 'error');
            }
        }

        // Stop recording
        async function stopRecording() {
            try {
                if (mediaRecorder) {
                    mediaRecorder.stop();
                }

                appState.recordingActive = false;

                document.getElementById('record-btn').innerHTML = '<span class="material-icons">fiber_manual_record</span><span>Record</span>';
                document.getElementById('record-btn').style.background = '';

                await queueCommand(CONFIG.COMMANDS.STOP_RECORDING);

                log.info('Recording stopped');

            } catch (error) {
                showToast(`Error stopping recording: ${error.message}`, 'error');
            }
        }
        // Local Storage Management for Flight History

        // Save flight data
        function saveFlight() {
            const flight = {
                id: Date.now(),
                date: new Date().toISOString(),
                duration: appState.flightTime,
                maxAltitude: appState.altitude,
                batteryUsed: 100 - appState.battery,
                distance: 0, // Calculate from GPS data
                startPosition: appState.position,
                notes: ''
            };

            const flights = getFlights();
            flights.unshift(flight);

            localStorage.setItem(CONFIG.STORAGE_KEYS.FLIGHTS, JSON.stringify(flights));

            loadFlightHistory();
            showToast('Flight saved to history', 'success');
            log.info(`Flight saved: ${flight.id}`);
        }

        // Get all flights
        function getFlights() {
            const saved = localStorage.getItem(CONFIG.STORAGE_KEYS.FLIGHTS);
            return saved ? JSON.parse(saved) : [];
        }

        // Load and display flight history
        function loadFlightHistory() {
            const flights = getFlights();
            const listEl = document.getElementById('flight-list');

            if (flights.length === 0) {
                listEl.innerHTML = '<p class="scanning-text">No flight history yet</p>';
                return;
            }

            listEl.innerHTML = '';

            flights.forEach(flight => {
                const item = createFlightItem(flight);
                listEl.appendChild(item);
            });
        }

        // Create flight list item
        function createFlightItem(flight) {
            const div = document.createElement('div');
            div.className = 'flight-item';

            const date = new Date(flight.date);
            const dateStr = date.toLocaleDateString();
            const timeStr = date.toLocaleTimeString();

            const hours = Math.floor(flight.duration / 3600);
            const minutes = Math.floor((flight.duration % 3600) / 60);
            const seconds = flight.duration % 60;
            const durationStr = `${hours > 0 ? hours + 'h ' : ''}${minutes}m ${seconds}s`;

            div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h4 style="margin-bottom: 0.5rem; color: var(--primary-color);">
                    Flight #${flight.id}
                </h4>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
                    <span class="material-icons" style="font-size: 1rem; vertical-align: middle;">event</span>
                    ${dateStr} at ${timeStr}
                </p>
            </div>
            <div style="text-align: right;">
                <p style="font-size: 0.875rem; color: var(--text-muted);">
                    Duration: <strong>${durationStr}</strong>
                </p>
                <p style="font-size: 0.875rem; color: var(--text-muted);">
                    Max Alt: <strong>${formatDistance(flight.maxAltitude)}</strong>
                </p>
            </div>
        </div>
    `;

            div.addEventListener('click', () => showFlightDetails(flight));

            return div;
        }

        // Show flight details modal
        function showFlightDetails(flight) {
            const modal = document.getElementById('flight-modal');
            const details = document.getElementById('flight-details');

            const date = new Date(flight.date);
            const hours = Math.floor(flight.duration / 3600);
            const minutes = Math.floor((flight.duration % 3600) / 60);
            const seconds = flight.duration % 60;

            details.innerHTML = `
        <div class="monitor-grid">
            <div class="monitor-card">
                <h3>Flight Information</h3>
                <div class="gps-display">
                    <div class="coordinate">
                        <label>Flight ID:</label>
                        <span>${flight.id}</span>
                    </div>
                    <div class="coordinate">
                        <label>Date:</label>
                        <span>${date.toLocaleDateString()}</span>
                    </div>
                    <div class="coordinate">
                        <label>Time:</label>
                        <span>${date.toLocaleTimeString()}</span>
                    </div>
                    <div class="coordinate">
                        <label>Duration:</label>
                        <span>${hours}h ${minutes}m ${seconds}s</span>
                    </div>
                </div>
            </div>
            <div class="monitor-card">
                <h3>Flight Statistics</h3>
                <div class="gps-display">
                    <div class="coordinate">
                        <label>Max Altitude:</label>
                        <span>${formatDistance(flight.maxAltitude)}</span>
                    </div>
                    <div class="coordinate">
                        <label>Battery Used:</label>
                        <span>${flight.batteryUsed}%</span>
                    </div>
                    <div class="coordinate">
                        <label>Start Lat:</label>
                        <span>${flight.startPosition.lat.toFixed(6)}</span>
                    </div>
                    <div class="coordinate">
                        <label>Start Lng:</label>
                        <span>${flight.startPosition.lng.toFixed(6)}</span>
                    </div>
                </div>
            </div>
        </div>
    `;

            modal.classList.remove('hidden');
        }

        // Export flight history
        function exportFlightHistory() {
            const flights = getFlights();

            if (flights.length === 0) {
                showToast('No flights to export', 'warning');
                return;
            }

            const dataStr = JSON.stringify(flights, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `drone_flight_history_${Date.now()}.json`;
            a.click();

            URL.revokeObjectURL(url);

            showToast('Flight history exported', 'success');
            log.info('Flight history exported');
        }

        // Clear flight history
        function clearFlightHistory() {
            const confirmed = confirm('Are you sure you want to clear all flight history? This cannot be undone.');

            if (!confirmed) return;

            localStorage.removeItem(CONFIG.STORAGE_KEYS.FLIGHTS);
            loadFlightHistory();
            showToast('Flight history cleared', 'info');
            log.info('Flight history cleared');
        }

        // Search and filter flights
        function setupFlightSearch() {
            const searchInput = document.getElementById('search-flights');
            const filterSelect = document.getElementById('filter-flights');

            const applyFilters = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filter = filterSelect.value;

                let flights = getFlights();

                // Apply time filter
                const now = new Date();
                if (filter === 'today') {
                    flights = flights.filter(f => {
                        const date = new Date(f.date);
                        return date.toDateString() === now.toDateString();
                    });
                } else if (filter === 'week') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    flights = flights.filter(f => new Date(f.date) >= weekAgo);
                } else if (filter === 'month') {
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    flights = flights.filter(f => new Date(f.date) >= monthAgo);
                }

                // Apply search
                if (searchTerm) {
                    flights = flights.filter(f => {
                        const searchableText = `${f.id} ${f.date} ${f.notes}`.toLowerCase();
                        return searchableText.includes(searchTerm);
                    });
                }

                // Render filtered flights
                const listEl = document.getElementById('flight-list');
                listEl.innerHTML = '';

                if (flights.length === 0) {
                    listEl.innerHTML = '<p class="scanning-text">No matching flights found</p>';
                } else {
                    flights.forEach(flight => {
                        const item = createFlightItem(flight);
                        listEl.appendChild(item);
                    });
                }
            };

            searchInput.addEventListener('input', applyFilters);
            filterSelect.addEventListener('change', applyFilters);
        }

        // Initialize search on load
        document.addEventListener('DOMContentLoaded', setupFlightSearch);
        // AI Object Detection Module (Optional Enhancement)

        let aiModel = null;
        let aiLabels = [];

        // Initialize AI detection
        async function initAIDetection() {
            try {
                showToast('Loading AI model...', 'info');
                log.info('Initializing AI detection');

                // In a real implementation, load TensorFlow Lite model
                // For demo, use mock detection
                aiModel = { loaded: true };
                aiLabels = ['person', 'car', 'tree', 'building', 'bird', 'dog', 'obstacle'];

                showToast('AI detection ready', 'success');
                log.info('AI model loaded');

                document.getElementById('detection-results').classList.remove('hidden');

            } catch (error) {
                showToast(`AI init failed: ${error.message}`, 'error');
                log.error(`AI error: ${error.message}`);
                document.getElementById('ai-detection-toggle').checked = false;
                appState.aiDetectionEnabled = false;
            }
        }

        // Detect objects in current frame
        function detectObjectsInFrame() {
            if (!aiModel || !canvas) return;

            // Mock detection for demo
            // In real implementation, use TensorFlow.js or similar
            const mockDetections = generateMockDetections();

            displayDetections(mockDetections);
        }

        // Generate mock detections for demo
        function generateMockDetections() {
            if (Math.random() < 0.7) return []; // 30% chance of detection

            const numObjects = Math.floor(Math.random() * 3) + 1;
            const detections = [];

            for (let i = 0; i < numObjects; i++) {
                const label = aiLabels[Math.floor(Math.random() * aiLabels.length)];
                const confidence = Math.random() * 0.4 + 0.6; // 0.6 to 1.0

                detections.push({
                    label,
                    confidence,
                    bbox: {
                        x: Math.random() * 0.8,
                        y: Math.random() * 0.8,
                        width: Math.random() * 0.2 + 0.1,
                        height: Math.random() * 0.2 + 0.1
                    }
                });
            }

            return detections;
        }

        // Display detection results
        function displayDetections(detections) {
            const listEl = document.getElementById('detected-objects');

            if (!detections || detections.length === 0) {
                listEl.innerHTML = '<li style="color: var(--text-muted);">No objects detected</li>';
                return;
            }

            listEl.innerHTML = '';

            detections.forEach(det => {
                const li = document.createElement('li');
                const confidence = (det.confidence * 100).toFixed(1);

                li.innerHTML = `
            <span>${det.label}</span>
            <span style="color: var(--success-color);">${confidence}%</span>
        `;

                listEl.appendChild(li);

                // Draw bounding box on canvas
                if (ctx && canvas) {
                    ctx.strokeStyle = '#00E676';
                    ctx.lineWidth = 3;
                    const x = det.bbox.x * canvas.width;
                    const y = det.bbox.y * canvas.height;
                    const w = det.bbox.width * canvas.width;
                    const h = det.bbox.height * canvas.height;

                    ctx.strokeRect(x, y, w, h);

                    // Draw label
                    ctx.fillStyle = 'rgba(0, 230, 118, 0.8)';
                    ctx.fillRect(x, y - 25, w, 25);
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = '14px Inter';
                    ctx.fillText(`${det.label} ${confidence}%`, x + 5, y - 7);
                }
            });
        }

        // Clean up AI resources
        function cleanupAI() {
            if (aiModel) {
                // In real implementation, dispose of model
                aiModel = null;
            }

            appState.aiDetectionEnabled = false;
            document.getElementById('detection-results').classList.add('hidden');
        }
        // Main Application Entry Point

        // App initialization
        class DroneControlApp {
            constructor() {
                this.version = '1.0.0';
                this.initialized = false;
            }

            async init() {
                try {
                    log.info('Initializing Drone Control App v' + this.version);

                    // Check browser compatibility
                    this.checkCompatibility();

                    // Initialize modules
                    await this.initModules();

                    // Set up event listeners
                    this.setupEventListeners();

                    // Check for saved device
                    this.checkLastDevice();

                    this.initialized = true;
                    log.info('App initialized successfully');

                } catch (error) {
                    log.error('App initialization failed: ' + error.message);
                    showToast('Failed to initialize app', 'error');
                }
            }

            checkCompatibility() {
                const features = {
                    'Web Bluetooth': isBluetoothSupported(),
                    'Canvas API': !!document.createElement('canvas').getContext,
                    'LocalStorage': typeof Storage !== 'undefined',
                    'MediaDevices': navigator.mediaDevices !== undefined
                };

                log.info('Browser Features:');
                Object.entries(features).forEach(([feature, supported]) => {
                    log.info(`  ${feature}: ${supported ? '' : ''}`);
                });

                if (!features['Web Bluetooth']) {
                    showToast('Web Bluetooth not supported. Some features may not work.', 'warning');
                }
            }

            async initModules() {
                // Modules are initialized via their respective files
                log.info('All modules loaded');
            }

            setupEventListeners() {
                // Handle app visibility changes
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        log.info('App hidden');
                    } else {
                        log.info('App visible');
                        // Refresh telemetry if connected
                        if (appState.connected) {
                            queueCommand(CONFIG.COMMANDS.GET_BATTERY);
                            queueCommand(CONFIG.COMMANDS.GET_POSITION);
                        }
                    }
                });

                // Handle orientation changes
                window.addEventListener('orientationchange', () => {
                    log.info('Orientation changed');
                    setTimeout(() => {
                        if (joystick) {
                            // Reinitialize joystick dimensions
                            const rect = joystick.container.getBoundingClientRect();
                            joystick.centerX = rect.width / 2;
                            joystick.centerY = rect.height / 2;
                            joystick.maxDistance = (rect.width / 2) - 40;
                        }
                    }, 100);
                });

                // Handle network status
                window.addEventListener('online', () => {
                    showToast('Internet connection restored', 'success');
                });

                window.addEventListener('offline', () => {
                    showToast('No internet connection', 'warning');
                });

                // Handle beforeunload
                window.addEventListener('beforeunload', (e) => {
                    if (appState.isFlying) {
                        e.preventDefault();
                        e.returnValue = 'Drone is still flying. Are you sure you want to leave?';
                        return e.returnValue;
                    }
                });

                // Add mock mode button for testing (hidden, press 'M' key)
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'm' || e.key === 'M') {
                        if (!appState.connected) {
                            enableMockMode();
                        }
                    }
                });
            }

            checkLastDevice() {
                const lastDeviceId = getLastDevice();
                if (lastDeviceId && appState.settings.autoReconnect) {
                    log.info(`Last device: ${lastDeviceId}`);
                    showToast('Press "Connect" to reconnect to your last drone', 'info');
                }
            }
        }

        // Create and initialize app instance
        const app = new DroneControlApp();

        // Start app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }

        // Service Worker for PWA (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => log.info('Service Worker registered'))
                    .catch(err => log.warn('Service Worker registration failed'));
            });
        }

        // Export for debugging
        window.droneApp = app;
        window.appState = appState;
        window.CONFIG = CONFIG;
    </script>
</body>

</html>